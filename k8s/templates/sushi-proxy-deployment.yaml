apiVersion: apps/v1
kind: Deployment
metadata:
    name: {{ .Values.global.name }}-proxy-deployment
    namespace: default
    labels:
      name: {{ .Values.global.name }}-proxy
    annotations: 
      checksum/config: {{ include (print $.Template.BasePath "/configmap.yaml") . | sha256sum }}
spec:
    replicas: {{ .Values.proxy.replicaCount }}
    selector:
      matchLabels:
        name: {{ .Values.global.name }}-proxy
    template:
      metadata:
        name: {{ .Values.global.name }}-proxy
        labels:
            name: {{ .Values.global.name }}-proxy
      spec:
        containers:
          - name: {{ .Values.global.name }}-proxy
            image: {{ .Values.image.sushi_proxy.repository }}:{{ .Values.image.sushi_proxy.tag }}
            ports:
            - containerPort: 8008
            - containerPort: 8081
            - containerPort: 8443
            envFrom:
              - configMapRef:
                  name: {{ .Values.configMap.configFile }}
              - secretRef:
                   name: sushi-secret
            env:
              - name: ADMIN_CORS_ORIGIN
                value: "http://127.0.0.1:55363"
            volumeMounts:
              - mountPath: {{ .Values.volumes.mountPath }}
                name: {{ .Values.volumes.configVolumeName }}
                subPath: {{ .Values.volumes.subPath }}
        volumes:
        - name: {{ .Values.volumes.configVolumeName }}
          configMap:
            name: {{ .Values.configMap.configFile }}